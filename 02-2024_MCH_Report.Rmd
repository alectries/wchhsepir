# 2024 MCH Report

WCHHS publishes an annual Maternal and Child Health Report, which provides information about maternal and child demographics, risk factors, morbidity, and mortality to the Wake County public, healthcare providers, and internal WCHHS programs.

For this report, I contributed a bit of data analysis with graphics. The graphics and all data management was done in R, and the code is shown below.

We will start by going through the `import.R` script, then look through the graph-generating R Markdown file. Unlike Section 1 (which relies partially on confidential data), this section was rendered with the actual data and outputs are shown as examples. The data used in this section is from the North Carolina BabyBook.[^02-2024_mch_report-1]

[^02-2024_mch_report-1]: The North Carolina BabyBook is published by the NC Department of Health and Human Services (DHHS) State Center for Health Statistics, and can be found [online](https://schs.dph.ncdhhs.gov/schs/births/babybook/2022/northcarolina.pdf).

## Libraries

```{r 02 import.R p1}
## libraries
suppressPackageStartupMessages(library(tidyverse))
library(readxl)
library(readr)
```

There are three non-standard libraries used in this script.

1. `tidyverse`: The tidyverse is a set of packages with a common syntax and philosophy. It includes many useful packages, such as `dplyr` (which provides many data management functions) and `ggplot2` (which is used to create all graphics in this presentation).
2. `readxl`: This package provides functions that read Microsoft Excel files.
3. `readr`: This package is useful for customizing how you read .csv files.

## Transposing data

For the analysis below, it is helpful to have a way to transpose (flip the rows and columns of) data. For this script, I wrote `sesh_transpose()`, which transposes the data in a more consistent and useful way than R's default `t()` function. Outside of the practicum, I later edited and added onto `sesh_transpose()` and published it in my `ezepi` package as `ezt()`, which I recommend using instead of copying this code. For this script, `sesh_transpose()` is sufficient.

```{r 02 import.R p2}
## transposing function
sesh_transpose <- function(x, row_name){
  counter <- nrow(x)
  name <- as.character(counter)
  df <- tibble({{name}} := slice(x, {{counter}}) %>% 
              unlist() %>% 
              as.vector())
  counter <- counter - 1
  repeat{
    if(counter == 0){
      break
    } else {
      name <- as.character(counter)
      df <- add_column(
        df,
        {{name}} := slice(x, {{counter}}) %>% 
          unlist() %>% 
          as.vector(),
        .before = 1
      )
      counter <- counter - 1
    }
  }
  df <- df %>% 
    setNames(slice(df, 1)) %>% 
    slice(-1) %>% 
    mutate(across(everything(), as.numeric)) %>% 
    add_column(
      {{row_name}} := names(x)[-1],
      .before = 1
    )
  return(df)
}
```

Because `ezt()` is publicly available, I will not explain this function in too much detail. Briefly, this function:

1. Sets a counter variable based on the number of rows in the dataset.
2. Sets the first column name to be generated to the counter variable.
3. Creates a dataset with one column, which is the bottom row of the original dataset.
4. Decreases the counter by one.
5. Starts a loop that grabs the last row of the remaining dataset, converts it to a column in the new dataset, and decreases the counter by one until the counter is zero.
6. Sets the first row of the new dataset as the column headers, then removes the first row.
7. Adds the column headers from the original dataset as the first column of the new dataset.

If this function would be useful to you, I suggest installing and exploring [ezepi](https://github.com/alectries/ezepi). Instructions for installation and use can be found in the bottom section of the `ezepi` homepage. You can also use `t()`, which is included in base R.

## Importing data

Now, we need to import data from an Excel workbook, which was manually copied from certain BabyBook tables. We can do this using the `readxl` package:

```{r 02 import.R p3}
## import data from Tables.xlsx
pncxedu <- read_xlsx("Tables.xlsx", sheet = "table-5")
pncxage <- read_xlsx("Tables.xlsx", sheet = "table-6") %>% 
  sesh_transpose("Month Prenatal Care Began")
pncxmarital <- read_xlsx("Tables.xlsx", sheet = "table-7")
pncxrace <- read_xlsx("Tables.xlsx", sheet = "race-table")
pncxbirthweight <- read_xlsx("Tables.xlsx", sheet = "table-9")
```

Notice that we transpose the table with prenatal care by age. That is because, unlike the other tables, Age is along the table's y-axis, while month prenatal care began is along the x-axis. `sesh_transpose()` flips these axes, and `"Month Prenatal Care Began"` is included as an argument to set the header for the first column, which will no longer be the maternal age.

## Cleaning and combining data

### Prenatal care initiation by maternal age

First, we deal with `pncxage`: the month prenatal care began stratified by maternal age.

```{r 02 import.R p4}
age <- pncxage %>% 
  mutate("19 and under" = rowSums(select(., `14`, `15`, `16`, `17`, `18`, `19`)),
         "20 through 24" = rowSums(select(., `20`, `21`, `22`, `23`, `24`)),
         .before = 2) %>% 
  sesh_transpose("Age") %>% 
  mutate("Early" = rowSums(select(., `First`, `Second`, `Third`)),
         "Not Early" = rowSums(select(., `Fourth`, `Fifth`, `Sixth`, `Seventh`, `Eighth`,
                                      `Ninth`, `None`)),
         .before = 2) %>% 
  select(Age, Early, `Not Early`, `Not Stated`) %>% 
  slice(1, 2, 14:19) %>% 
  mutate("Total" = rowSums(across(where(is.numeric))),
         "Risk" = Early/Total)
```

This block of code performs the following tasks:

1. _Mutate_ (create) a column for births where the mother was 19 years old or under by summing the counts for age 14-19 and a column for births where the mother was 20 through 24 by summing those counts.
2. Transpose the dataset again, so maternal age is now on the y-axis and month prenatal care began is on the x-axis.
3. _Mutate_ (create) a column for early prenatal care (initiated in the first trimester) and a column for not early (initiated after the first trimester or not initiated), summing the respective month columns.
4. _Select_ just the maternal age, early and not early counts, and not stated columns, removing the columns with individual months when prenatal care was initiated.
5. _Slice_ (select by their number) the rows with the age groupings of interest.
6. _Mutate_ (create) a Total and Risk column for early prenatal care initiation.

The output of this code is shown below.

```{r 02 import.R p4vis, echo = FALSE}
knitr::kable(age, "html") %>% 
  kableExtra::kable_material("striped")
```

### Prenatal care initiation by maternal education

Next, we deal with `pncxedu`. This is performed very similarly to maternal age, but with slightly fewer steps.

```{r 02 import.R p5}
edu <- pncxedu %>% 
  sesh_transpose("Education") %>% 
  mutate("Early" = rowSums(select(., `First`, `Second`, `Third`)),
         "Not Early" = rowSums(select(., `Fourth`, `Fifth`, `Sixth`, `Seventh`, `Eighth`,
                                      `Ninth`, `None`)),
         .before = 2) %>% 
  select(Education, Early, `Not Early`, `Not Stated`) %>% 
  mutate("Total" = rowSums(across(where(is.numeric))),
         "Risk" = Early/Total)
```

For education, we do not need to define new categories for education level and remove extraneous ones, so this function is simpler. The output is shown below:

```{r 02 import.R p5vis, echo = FALSE}
knitr::kable(edu, "html") %>% 
  kableExtra::kable_material("striped")
```

### Prenatal care initiation by marital status

Next is `pncxmarital`. Like `pncxedu`, this is much simpler. Here is the code:

```{r 02 import.R p6}
marital <- pncxmarital %>% 
  sesh_transpose("Marital Status") %>% 
  mutate("Early" = rowSums(select(., `First`, `Second`, `Third`)),
         "Not Early" = rowSums(select(., `Fourth`, `Fifth`, `Sixth`, `Seventh`, `Eighth`,
                                      `Ninth`, `None`)),
         .before = 2) %>% 
  select(`Marital Status`, Early, `Not Early`, `Not Stated`) %>% 
  mutate("Total" = rowSums(across(where(is.numeric))),
         "Risk" = Early/Total)
```

And the output:

```{r 02 import.R p6vis, echo = FALSE}
knitr::kable(marital, "html") %>% 
  kableExtra::kable_material("striped")
```

### Prenatal care initiation by maternal race and ethnicity

Now, we do `pncxrace`. Here is the code:

```{r 02 import.R p7}
race <- pncxrace %>% 
  sesh_transpose("Race/Ethnicity") %>% 
  mutate("Early" = rowSums(select(., `First`, `Second`, `Third`)),
         "Not Early" = rowSums(select(., `Fourth`, `Fifth`, `Sixth`, `Seventh`, `Eighth`,
                                      `Ninth`, `None`)),
         .before = 2) %>% 
  select(`Race/Ethnicity`, Early, `Not Early`, `Not Stated`) %>% 
  mutate("Total" = rowSums(across(where(is.numeric))),
         "Risk" = Early/Total)
```

And the output:

```{r 02 import.R p7vis, echo = FALSE}
knitr::kable(race, "html") %>% 
  kableExtra::kable_material("striped")
```

### Birthweight by prenatal care initiation

Last, we do something a bit different: we look at birthweight (in three categories) by prenatal care initiation. Here is the code:

```{r 02 import.R p8}
birthweight <- pncxbirthweight %>% 
  sesh_transpose("Birth weight (g)") %>% 
  mutate("Early" = rowSums(select(., `First`, `Second`, `Third`)),
         "Not Early" = rowSums(select(., `Fourth`, `Fifth`, `Sixth`, `Seventh`, `Eighth`,
                                      `Ninth`, `None`)),
         .before = 2) %>% 
  select(`Birth weight (g)`, Early, `Not Early`, `Not Stated`) %>% 
  mutate("Total" = rowSums(across(where(is.numeric))),
         "Early" = Early/Total,
         "Not Early" = `Not Early`/Total,
         "Not Stated" = `Not Stated`/Total) %>% 
  select(!Total) %>% 
  pivot_longer(
    cols = where(is.numeric),
    names_to = "Prenatal Care",
    values_to = "Values"
  )
```

Here is the output:

```{r 02 import.R p8vis, echo = FALSE}
knitr::kable(birthweight, "html") %>% 
  kableExtra::kable_material("striped")
```

This table appears different because it was _pivoted_: the prenatal care column names were turned into values of a new `Prenatal care` column, and the table was given more rows to accommodate the switch. This is useful for the specific kind of graph (a stacked bar graph) we will make with the birthweight data in a moment.

## Exporting data

These datasets are then exported to .csv files.

```{r 02 import.R p9}
## save tables
write_csv(age, "Tables/age.csv")
write_csv(edu, "Tables/edu.csv")
write_csv(marital, "Tables/marital.csv")
write_csv(race, "Tables/race.csv")
write_csv(birthweight, "Tables/birthweight.csv")
```

## Graphing data

Now, we move on to graphing. These tasks are done in `bar-graphs.Rmd`. We want to produce five graphs:

1. Four bar graphs showing the percent of people initiating prenatal care in the first trimester at each age group, education level, marital status, and race/ethnicity group.
2. One stacked bar graph showing the percent of births in each birthweight class receiving early prenatal care, non-early prenatal care, or not stated.

### Prenatal care initiation by maternal age

```{r Age}
# Read the age.csv dataset
read_csv("Tables/age.csv", show_col_types = FALSE) %>% 
  
  # Add a Risk column for the percent in each age group receiving early care
  mutate(Risk = round(Risk * 100, 1)) %>% 
  
  # Initiate the graph, with Age on the x-axis and determining the bar color and Risk on the y-axis
  ggplot(aes(x = Age, y = Risk, fill = Age)) +
  
  # Make a column (bar) graph and add a black outline to the bars
  geom_col(color = "black") +
  
  # Add percent labels
  geom_label(
    aes(label = paste0(Risk, "%")), # Add percent to the end of the numeric value
    vjust = -0.5                    # Center the label
  ) +
  
  # Change the y-axis label
  ylab("Percent receiving early prenatal care") +
  
  # Change the y-axis scale limits
  ylim(0, 100) +
  
  # Set the color scheme (use RColorBrewer color set 3)
  scale_fill_brewer(palette = "Set3") +
  
  # Set the overall ggplot theme
  theme_minimal() +
  
  # Set the plot title
  ggtitle("Prenatal Care in First Trimester by Age Group, 2022") +
  
  # Set specific theme elements
  theme(axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1), # Tilt the x-axis labels
        plot.title = element_text(hjust = 0.5)) +                     # Center the plot title
  
  # Remove the legend
  guides(fill = "none")
```

See the code comments explaining this code above for details. The following three graphs are similar, so there are no code comments included with them.

### Prenatal care initiation by maternal education

```{r Education}
read_csv("Tables/edu.csv", show_col_types = FALSE) %>% 
  mutate(Risk = round(Risk * 100, 1)) %>% 
  mutate(Education = factor(
    .$Education,
    levels = c("Less than High School", "High School Graduate or GED",
               "Some College", "Bachelors Degree", "Masters or PhD",
               "Unknown")
  )) %>% 
  ggplot(aes(x = Education, y = Risk, fill = Education)) +
  geom_col(color = "black") +
  geom_label(
    aes(label = paste0(Risk, "%")),
    vjust = -0.5
  ) +
  ylab("Percent receiving early prenatal care") +
  ylim(0, 100) +
  scale_fill_brewer(palette = "Set3") +
  theme_minimal() +
  ggtitle("Prenatal Care in First Trimester by Education Level, 2022") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1),
        plot.title = element_text(hjust = 0.5)) +
  guides(fill = "none")
```

Note one addition here: the Education variable is created as a factor, which allows the x-axis to be ordered logically. If the education variable were a character vector instead of a factor, the education levels would be alphabetized.

### Prenatal care initiation by marital status

```{r Marital}
read_csv("Tables/marital.csv", show_col_types = FALSE) %>% 
  mutate(Risk = round(Risk * 100, 1)) %>% 
  mutate(`Marital Status` = factor(.$`Marital Status`,
                                   levels = c("Married", "Unmarried", "Not Stated"))) %>% 
  ggplot(aes(x = `Marital Status`, y = Risk, fill = `Marital Status`)) +
  geom_col(color = "black") +
  geom_label(
    aes(label = paste0(Risk, "%")),
    vjust = -0.5
  ) +
  ylab("Percent receiving early prenatal care") +
  ylim(0, 100) +
  scale_fill_brewer(palette = "Set3") +
  theme_minimal() +
  ggtitle("Prenatal Care in First Trimester by Marital Status, 2022") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1),
        plot.title = element_text(hjust = 0.5)) +
  guides(fill = "none")
```

As with education status, marital status is changed to a factor so the x-axis is properly ordered.

### Prenatal care initiation by race and ethnicity

```{r Race}
read_csv("Tables/race.csv", show_col_types = FALSE) %>% 
  mutate(Risk = round(Risk * 100, 1)) %>% 
  mutate(`Race/Ethnicity` = factor(
    .$`Race/Ethnicity`,
    levels = c("White/Non-Hispanic", "Other/Non-Hispanic", "African American/Non-Hispanic",
               "Hispanic")
  )) %>% 
  ggplot(aes(x = `Race/Ethnicity`, y = Risk, fill = `Race/Ethnicity`)) +
  geom_col(color = "black") +
  geom_label(
    aes(label = paste0(Risk, "%")),
    vjust = -0.5
  ) +
  ylab("Percent receiving early prenatal care") +
  ylim(0, 100) +
  scale_fill_brewer(palette = "Set3") +
  theme_minimal() +
  ggtitle("Prenatal Care in First Trimester by Race/Ethnicity, 2022") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1),
        plot.title = element_text(hjust = 0.5)) +
  guides(fill = "none")
```

Once again, race/ethnicity is changed to a factor to preserve a logical x-axis: in this case, the order was chosen to show groups from highest early prenatal care uptake to lowest.

### Birthweight by prenatal care initiation

For the final graph, we create a stacked bar graph. This is more useful in this case, because we can more easily show the effect of prenatal care initiation on birthweight.

```{r Birthweight}
# Read the birthweight.csv dataset
read_csv("Tables/birthweight.csv", show_col_types = FALSE) %>% 
  
  # Multiply the risks by 100 (to create percents) and round to the tenths place.
  mutate(Values = round(Values * 100, 1)) %>% 
  
  # Change the birthweight variable to an ordered factor
  mutate(`Birth weight (g)` = factor(
    .$`Birth weight (g)`,
    levels = c("<1500", "1500-2499", ">=2500", "Unknown")
  )) %>% 
  
  # Initiate the graph, with birthweight on the x-axis and percent on the y-axis
  ggplot(aes(x = `Birth weight (g)`, y = Values, fill = `Prenatal Care`)) + 
  
  # Create a column (bar) graph
  geom_col(color = "black") +
  
  # Add percent labels
  geom_label(
    aes(label = paste0(Values, "%")),       # Add percent to the end of the numeric value
    position = position_stack(vjust = 0.5), # Center the labels and stack them like the bars
    show.legend = FALSE                     # Remove the labels from the legend
  ) +
  
  # Set the y-axis label
  ylab("Percent") +
  
  # Set the y-axis limits
  ylim(0, 100) +
  
  # Set the color scheme (to RColorBrewer's color set 3)
  scale_fill_brewer(palette = "Set3") +
  
  # Set the ggplot theme
  theme_minimal() +
  
  # Set the plot title
  ggtitle("Prenatal Care in First Trimester by Birth Weight, 2022") +
  
  # Change theme settings
  theme(axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1), # Angle the x-axis labels
        plot.title = element_text(hjust = 0.5),                       # Center the plot title
        legend.position = "right")                                    # Position the legend
```

See the code comments explaining this code above for details.

## Calculating risk ratios for early prenatal care

In this section, we generate tables that show risk ratios for each category graphed above. The ratios calculated here say how many times as likely a member of each group was to obtain early prenatal care (initiated in the first trimester) compared to the group overall.

First, we need to load some additional libraries:

```{r RR libs, warning = FALSE}
suppressPackageStartupMessages(library(knitr))
suppressPackageStartupMessages(library(kableExtra))
```

1. `knitr` is used to "knit" (render) RMarkdown files. In addition to `bar-graphs.Rmd`, this presentation was generated with `knitr`.
2. `kableExtra` is used to style tables generated with `kable()`, which is a function from `knitr`. The tables in the sections above were kables styled with `kableExtra`.

### Risk of prenatal care initiation by maternal age

We need to calculate a risk ratio here. As a reminder, risk ratios are calculated as $\frac{a/(a+b)}{c/(c+d)}$, where:

1. $a$ are those with the outcome who were exposed.
2. $b$ are those _without_ the outcome who were exposed.
3. $c$ are those with the outcome who were _not_ exposed.
4. $d$ are those _without_ the outcome who were _not_ exposed.

In this case, we will calculate the risk of each category over the overall population's risk for the risk ratio. The following code demonstrates how this is done:

```{r Age RR}
# Read the age.csv dataset
read_csv("Tables/age.csv", show_col_types = FALSE) %>% 
  
  # Remove the existing Risk column
  select(!Risk) %>% 
  
  # Generate a totals row which sums all births with early care, no early care, and not stated
  bind_rows(
    summarise_all(., ~if(is.numeric(.)) sum(.) else "Total")
  ) %>% 
  
  # Calculate risk again
  mutate(
    "Risk" = Early / Total
  ) %>% 
  
  # Calculate a risk ratio by dividing each row's risk by the risk in the Total row
  mutate(
    "RR" = Risk / filter(., Age == "Total") %>% pull(Risk)
  ) %>% 
  
  # Select only the needed columns
  select(Age, Total, RR) %>% 
  
  # Generate a table
  kable("html") %>% 
  kable_material("striped")
```

Note: the code used to generate the tables is different in this presentation for design consistency. You can refer to `bar-graphs.Rmd` for the style commands used there.

The next three tables are generated the same way, so code comments are not given.

### Risk of prenatal care initiation by maternal education

```{r Education RR}
read_csv("Tables/edu.csv", show_col_types = FALSE) %>% 
  select(!Risk) %>% 
  bind_rows(
    summarise_all(., ~if(is.numeric(.)) sum(.) else "Total")
  ) %>% 
  mutate(
    "Risk" = Early / Total
  ) %>% 
  mutate(
    "RR" = Risk / filter(., Education == "Total") %>% pull(Risk)
  ) %>% 
  select(Education, Total, RR) %>% 
  kable("html") %>% 
  kable_material("striped")
```

### Risk of prenatal care initiation by marital status
```{r Marital RR}
read_csv("Tables/marital.csv", show_col_types = FALSE) %>% 
  select(!Risk) %>% 
  bind_rows(
    summarise_all(., ~if(is.numeric(.)) sum(.) else "Total")
  ) %>% 
  mutate(
    "Risk" = Early / Total
  ) %>% 
  mutate(
    "RR" = Risk / filter(., `Marital Status` == "Total") %>% pull(Risk)
  ) %>% 
  select(`Marital Status`, Total, RR) %>% 
  kable("html") %>% 
  kable_material("striped")
```

### Risk of prenatal care initiation by race and ethnicity
```{r Race RR}
read_csv("Tables/race.csv", show_col_types = FALSE) %>% 
  select(!Risk) %>% 
  bind_rows(
    summarise_all(., ~if(is.numeric(.)) sum(.) else "Total")
  ) %>% 
  mutate(
    "Risk" = Early / Total
  ) %>% 
  mutate(
    "RR" = Risk / filter(., `Race/Ethnicity` == "Total") %>% pull(Risk)
  ) %>% 
  select(`Race/Ethnicity`, Total, RR) %>% 
  kable("html") %>% 
  kable_material("striped")
```

## Final notes

This is the end of the R code contributed to the 2024 Maternal and Child Health Report. Not all of these graphics and tables will be included in the final report, but with R, it is relatively painless to generate more graphs and tables than are needed.